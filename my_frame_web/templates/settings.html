<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Frame - Settings</title>
    <style>
        :root {
            --bg: #f2f2f7;
            --card: #ffffff;
            --text: #1c1c1e;
            --blue: #007aff;
            --red: #ff3b30;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        h2 {
            font-size: 20px;
            margin-top: 0;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            background: linear-gradient(180deg, #007aff 0%, #0062cc 100%);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
            box-shadow:
                0 4px 12px rgba(0, 122, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.4),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1);
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 50%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0) 100%);
            border-radius: 12px 12px 0 0;
            pointer-events: none;
        }

        .btn:hover {
            transform: scale(1.02);
            filter: brightness(1.1);
            box-shadow:
                0 6px 16px rgba(0, 122, 255, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: linear-gradient(180deg, #ffffff 0%, #f2f2f7 100%);
            color: #007aff;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 1.0);
        }

        .btn-secondary::after {
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0) 100%);
        }

        .btn-danger {
            background: linear-gradient(180deg, #ff3b30 0%, #d63229 100%);
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);
        }

        .btn-danger:hover {
            box-shadow: 0 6px 16px rgba(255, 59, 48, 0.4);
        }

        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e5ea;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .list-group {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .list-item {
            padding: 10px;
            border-bottom: 1px solid #e5e5ea;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list-item:hover {
            background: #f9f9f9;
        }

        .hidden {
            display: none;
        }

        /* Helper for small buttons */
        .btn-sm {
            width: auto !important;
            display: inline-block !important;
            padding: 8px 16px !important;
            font-size: 14px !important;
            margin-top: 0 !important;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h1 style="margin:0; font-size:24px;">Settings</h1>
            <a href="/" class="btn btn-secondary btn-sm">ë‹«ê¸°</a>
        </div>

        <!-- Location Settings -->
        <div class="card">
            <h2>ğŸ“ ìœ„ì¹˜ ì„¤ì • (ë‚ ì”¨ìš©)</h2>
            <div style="display:flex; gap:10px;">
                <input type="text" id="locSearch" placeholder="ë™ ì´ë¦„ ê²€ìƒ‰ (ì˜ˆ: ê³ ë•)">
                <button class="btn btn-sm" onclick="searchLocation()">ê²€ìƒ‰</button>
            </div>
            <ul id="locList" class="list-group" style="margin-top:10px; max-height:200px; overflow-y:auto;"></ul>
            <p id="currentLoc" style="color:#666; font-size:14px; margin-top:10px;">í˜„ì¬: ë¡œë”© ì¤‘...</p>
        </div>

        <!-- WiFi Settings -->
        <div class="card">
            <h2>ğŸ“¶ Wi-Fi ì—°ê²°</h2>
            <button class="btn btn-secondary" onclick="scanWifi()" style="width:100%; margin-bottom:10px;">ì£¼ë³€ ì™€ì´íŒŒì´
                ìŠ¤ìº”</button>
            <ul id="wifiList" class="list-group"></ul>

            <div id="wifiInput" class="hidden"
                style="margin-top:15px; background:#f9f9f9; padding:15px; border-radius:8px;">
                <h3 id="targetSSID" style="margin:0 0 10px 0;"></h3>
                <input type="password" id="wifiPw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                <button class="btn" onclick="connectWifi()">ì—°ê²° ì‹œë„</button>
                <button class="btn btn-secondary"
                    onclick="document.getElementById('wifiInput').classList.add('hidden')">ì·¨ì†Œ</button>
            </div>
        </div>

        <!-- Data API Settings -->
        <div class="card">
            <h2>â˜ï¸ ë‚ ì”¨/ë¯¸ì„¸ë¨¼ì§€ í‚¤ ì„¤ì •</h2>
            <div style="margin-bottom:10px;">
                <label>ê¸°ìƒì²­ API Key (Encoding):</label>
                <input type="password" id="kmaKey" placeholder="ê³µê³µë°ì´í„°í¬í„¸ ë‹¨ê¸°ì˜ˆë³´ Key">
            </div>
            <div style="margin-bottom:10px;">
                <label>ì—ì–´ì½”ë¦¬ì•„ API Key (Encoding):</label>
                <input type="password" id="airKey" placeholder="ê³µê³µë°ì´í„°í¬í„¸ ëŒ€ê¸°ì˜¤ì—¼ì •ë³´ Key">
            </div>
            <button class="btn" onclick="saveDataSettings()">í‚¤ ì €ì¥</button>
            <p style="font-size:12px; color:#888; margin-top:10px;">* ì¸ì¦í‚¤ê°€ ì—†ìœ¼ë©´ ë¯¸ë¦¬ë³´ê¸° ë°ì´í„°ëŠ” ì„ì˜ê°’(Mock)ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.<br>* Key ì €ì¥
                í›„ ë°˜ì˜ê¹Œì§€ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>

        <!-- AI Settings -->
        <div class="card">
            <h2>ğŸ¤– AI ì´ë¯¸ì§€ ì„¤ì •</h2>
            <div style="margin-bottom:10px;">
                <label>ì œê³µì (Provider):</label>
                <select id="aiProvider"
                    style="width:100%; padding:10px; margin-top:5px; border-radius:8px; border:1px solid #e5e5ea;">
                    <option value="huggingface">Hugging Face (ë¬´ë£Œ/ë¹ ë¦„)</option>
                    <option value="openai">OpenAI DALL-E 3 (ìœ ë£Œ/ê³ í’ˆì§ˆ)</option>
                </select>
            </div>
            <div style="margin-bottom:10px;">
                <label>API Key:</label>
                <input type="password" id="aiApiKey" placeholder="API Key ì…ë ¥ (hf_... or sk-...)">
            </div>
            <button class="btn" onclick="saveAiSettings()">AI ì„¤ì • ì €ì¥</button>
            <p style="font-size:12px; color:#888; margin-top:10px;">* Hugging FaceëŠ” ë¬´ë£Œ í† í°ì„ ë°œê¸‰ë°›ì•„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>* OpenAIëŠ”
                ê³¼ê¸ˆì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>

        <!-- System -->
        <div class="card">
            <h2>âš™ï¸ ì‹œìŠ¤í…œ</h2>
            <p>PiSugar ë°°í„°ë¦¬: <span id="batteryStatus">-</span></p>
            <button class="btn btn-danger" onclick="callSystem('shutdown')">ì‹œìŠ¤í…œ ì¢…ë£Œ</button>
            <button class="btn btn-secondary" onclick="callSystem('reboot')">ì¬ë¶€íŒ…</button>
            <button class="btn" style="margin-top:10px; background: linear-gradient(180deg, #34c759 0%, #30b351 100%);"
                onclick="updateFirmware()">ğŸ”„ íŒì›¨ì–´ ì—…ë°ì´íŠ¸ (Git Pull)</button>
        </div>
        <!-- Custom Modal -->
        <div id="confirmModal" class="hidden"
            style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
            <div
                style="background:white; padding:20px; border-radius:15px; width:300px; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.2);">
                <h3 id="modalTitle" style="margin-top:0;">ìœ„ì¹˜ ì„¤ì •</h3>
                <p id="modalDesc">ì´ ìœ„ì¹˜ë¡œ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                <div style="display:flex; justify-content:space-around; margin-top:20px;">
                    <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                    <button class="btn" id="btnConfirmAction">í™•ì¸</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load initial config
        let currentConfig = {};

        async function loadConfig() {
            try {
                const res = await fetch('/api/get_config');
                currentConfig = await res.json();
                if (currentConfig.location) {
                    document.getElementById('currentLoc').innerText = `í˜„ì¬: ${currentConfig.location.name}`;
                }
                // AI Config Load
                if (currentConfig.api_key_ai) document.getElementById('aiApiKey').value = currentConfig.api_key_ai;
                if (currentConfig.ai_provider) document.getElementById('aiProvider').value = currentConfig.ai_provider;

                // Data API Config Load
                if (currentConfig.api_key_kma) document.getElementById('kmaKey').value = currentConfig.api_key_kma;
                if (currentConfig.api_key_air) document.getElementById('airKey').value = currentConfig.api_key_air;

            } catch (e) { console.error(e); }
        }
        loadConfig();

        async function saveDataSettings() {
            const kma = document.getElementById('kmaKey').value;
            const air = document.getElementById('airKey').value;

            const newConfig = {
                api_key_kma: kma,
                api_key_air: air
            };

            await fetch('/api/save_config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newConfig)
            });
            alert("í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (í™”ë©´ì´ ì ì‹œ í›„ ê°±ì‹ ë©ë‹ˆë‹¤)");
        }

        async function saveAiSettings() {
            const key = document.getElementById('aiApiKey').value;
            const provider = document.getElementById('aiProvider').value;

            const newConfig = {
                api_key_ai: key,
                ai_provider: provider
            };

            await fetch('/api/save_config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newConfig)
            });
            alert("AI ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (í™”ë©´ì´ ì ì‹œ í›„ ê°±ì‹ ë©ë‹ˆë‹¤)");
        }

        // Location Search
        async function searchLocation() {
            const query = document.getElementById('locSearch').value;
            if (query.length < 2) return alert("2ê¸€ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.");

            const res = await fetch(`/api/search_location?q=${query}`);
            const data = await res.json();

            const list = document.getElementById('locList');
            list.innerHTML = "";

            if (data.length === 0) {
                list.innerHTML = "<li class='list-item'>ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</li>";
                return;
            }

            data.forEach(item => {
                const li = document.createElement('li');
                li.className = 'list-item';
                li.innerText = item.name;
                li.onclick = () => selectLocation(item);
                list.appendChild(li);
            });
        }

        let pendingLoc = null;

        function selectLocation(locData) {
            pendingLoc = locData;
            document.getElementById('modalTitle').innerText = "ìœ„ì¹˜ ì„¤ì •";
            document.getElementById('modalDesc').innerText = `${locData.name}ìœ¼ë¡œ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;

            const btn = document.getElementById('btnConfirmAction');
            btn.disabled = false;
            btn.innerText = "í™•ì¸";

            const modal = document.getElementById('confirmModal');
            modal.style.display = 'flex'; // Override hidden class

            btn.onclick = confirmLocationSet;
        }

        function closeModal() {
            document.getElementById('confirmModal').style.display = 'none';
            pendingLoc = null;
        }

        async function confirmLocationSet() {
            if (!pendingLoc) return;

            // Prevent double click
            const btn = document.getElementById('btnConfirmAction');
            btn.disabled = true;
            btn.innerText = "ì €ì¥ ì¤‘...";

            const locData = pendingLoc;

            try {
                // Save config
                const newConfig = {
                    location: {
                        name: locData.name,
                        nx: locData.nx,
                        ny: locData.ny
                    }
                };

                await fetch('/api/save_config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newConfig)
                });

                // Show success feedback in modal then reload
                document.getElementById('modalTitle').innerText = "ì™„ë£Œ";
                document.getElementById('modalDesc').innerText = "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ë¦¬ë¡œë”©í•©ë‹ˆë‹¤...";

                setTimeout(() => {
                    location.reload();
                }, 1000);
            } catch (e) {
                console.error(e);
                closeModal();
                alert("ì €ì¥ ì‹¤íŒ¨");
            }
        }

        // WiFi
        async function scanWifi() {
            const list = document.getElementById('wifiList');
            list.innerHTML = "<li>ìŠ¤ìº” ì¤‘...</li>";

            try {
                const res = await fetch('/api/wifi_scan');
                const data = await res.json();

                list.innerHTML = "";
                data.forEach(net => {
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    li.innerHTML = `<span>${net.ssid}</span> <span style='font-size:12px; color:#888;'>${net.signal}%</span>`;
                    li.onclick = () => showWifiInput(net.ssid);
                    list.appendChild(li);
                });
            } catch (e) {
                list.innerHTML = "<li>ìŠ¤ìº” ì‹¤íŒ¨</li>";
            }
        }

        let selectedSSID = "";
        function showWifiInput(ssid) {
            selectedSSID = ssid;
            document.getElementById('targetSSID').innerText = ssid;
            document.getElementById('wifiInput').classList.remove('hidden');
        }

        async function connectWifi() {
            const pw = document.getElementById('wifiPw').value;
            if (!pw) return alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

            alert("ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤. (ì•½ 10~20ì´ˆ ì†Œìš”)");

            fetch('/api/wifi_connect', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ssid: selectedSSID, password: pw })
            });
        }

        // Upload
        async function handleUpload(input) {
            const files = input.files;
            if (!files.length) return;

            const status = document.getElementById('uploadStatus');
            status.innerText = "ì—…ë¡œë“œ ì¤‘...";

            for (let file of files) {
                const formData = new FormData();
                formData.append('file', file);
                await fetch('/upload', { method: 'POST', body: formData });
            }
            status.innerText = "ì—…ë¡œë“œ ì™„ë£Œ!";
        }

        async function updateFirmware() {
            if (!confirm("ìµœì‹  íŒì›¨ì–´ë¥¼ ë°›ì•„ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ? (ì„œë²„ ì¬ì‹œì‘ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤)")) return;

            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "ì—…ë°ì´íŠ¸ ì§„í–‰ ì¤‘...";
            btn.disabled = true;

            try {
                const res = await fetch('/api/system?action=update');
                const data = await res.json();

                if (data.status === 'success') {
                    alert("ì—…ë°ì´íŠ¸ ì„±ê³µ!\n" + data.message + "\në³€ê²½ëœ ì‚¬í•­ì„ ì ìš©í•˜ê¸° ìœ„í•´ ì¬ë¶€íŒ…í•´ì£¼ì„¸ìš”.");
                    if (confirm("ì¬ë¶€íŒ… í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        callSystem('reboot');
                    }
                } else {
                    alert("ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:\n" + data.message);
                }
            } catch (e) {
                alert("í†µì‹  ì˜¤ë¥˜ ë°œìƒ");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function callSystem(action) {
            if (confirm("ì •ë§ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                fetch(`/api/system?action=${action}`); // Needs implementing in app.py
            }
        }

    </script>
</body>

</html>
```